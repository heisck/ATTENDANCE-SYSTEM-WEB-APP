generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  LECTURER
  STUDENT
}

enum SessionStatus {
  ACTIVE
  CLOSED
}

enum AttendancePhase {
  INITIAL
  REVERIFY
  CLOSED
}

enum ReverifyStatus {
  NOT_REQUIRED
  PENDING
  RETRY_PENDING
  MISSED
  PASSED
  FAILED
  MANUAL_PRESENT
}

enum SubscriptionPlan {
  FREE
  BASIC
  PRO
  ENTERPRISE
}

enum EmailVerificationTokenType {
  PERSONAL_EMAIL_VERIFY
}

enum NotificationType {
  UPCOMING_CLASS
  ATTENDANCE_RISK
  SYSTEM
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  domain    String?
  logoUrl   String?
  apiKey    String?  @unique // For public API access
  settings  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users        User[]
  courses      Course[]
  subscription Subscription?
  ipRanges     TrustedIpRange[]
  lecturerInvites LecturerInvite[]

  @@index([slug])
  @@index([apiKey])
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  personalEmail  String?  @unique
  name           String
  passwordHash   String
  role           Role     @default(STUDENT)
  studentId      String?  @unique
  indexNumber    String?  @unique
  organizationId String?
  emailVerified  DateTime?
  personalEmailVerifiedAt DateTime?
  lastProfileCompletionPromptAt DateTime?
  image          String?
  passkeysLockedUntilAdminReset Boolean @default(false)
  firstPasskeyCreatedAt DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization?        @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  credentials  WebAuthnCredential[]
  attendances  AttendanceRecord[]
  sessions     AttendanceSession[]  @relation("LecturerSessions")
  courses      Course[]             @relation("LecturerCourses")
  enrollments  Enrollment[]
  auditLogs    AuditLog[]
  lecturerInvitesCreated LecturerInvite[] @relation("LecturerInvitesCreatedBy")
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens PasswordResetToken[]
  pushSubscriptions PushSubscription[]
  notifications UserNotification[]

  @@index([email])
  @@index([personalEmail])
  @@index([organizationId])
  @@index([role])
  @@index([passkeysLockedUntilAdminReset])
}

model WebAuthnChallenge {
  id        String   @id @default(cuid())
  userId    String
  challenge String
  expiresAt DateTime

  @@index([userId])
  @@index([expiresAt])
}

model WebAuthnCredential {
  id               String   @id @default(cuid())
  userId           String
  credentialId     String   @unique
  publicKey        Bytes
  counter          BigInt   @default(0)
  transports       String[]
  deviceType       String
  backedUp         Boolean  @default(false)
  userAgent        String?
  registeredAt     DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([credentialId])
}

model Course {
  id             String   @id @default(cuid())
  code           String
  name           String
  description    String?
  organizationId String
  lecturerId     String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  lecturer     User                @relation("LecturerCourses", fields: [lecturerId], references: [id])
  enrollments  Enrollment[]
  sessions     AttendanceSession[]

  @@unique([code, organizationId])
  @@index([organizationId])
  @@index([lecturerId])
}

model Enrollment {
  id        String   @id @default(cuid())
  courseId   String
  studentId  String
  enrolledAt DateTime @default(now())

  course  Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student User   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([courseId, studentId])
}

model AttendanceSession {
  id           String        @id @default(cuid())
  courseId      String
  lecturerId   String
  status       SessionStatus @default(ACTIVE)
  phase        AttendancePhase @default(INITIAL)
  initialEndsAt DateTime?
  reverifyEndsAt DateTime?
  qrRotationMs Int           @default(5000)
  qrGraceMs    Int           @default(1000)
  reverifySelectionRate Float @default(0.3)
  reverifySelectionDone Boolean @default(false)
  reverifySelectedCount Int  @default(0)
  gpsLat       Float
  gpsLng       Float
  radiusMeters Int           @default(500)
  qrSecret     String
  startedAt    DateTime      @default(now())
  closedAt     DateTime?

  course   Course             @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lecturer User               @relation("LecturerSessions", fields: [lecturerId], references: [id])
  records  AttendanceRecord[]

  @@index([courseId])
  @@index([lecturerId])
  @@index([status])
  @@index([phase])
}

model AttendanceRecord {
  id           String   @id @default(cuid())
  sessionId    String
  studentId    String
  gpsLat       Float
  gpsLng       Float
  gpsDistance   Float
  ipAddress    String
  ipTrusted    Boolean  @default(false)
  qrToken      String
  webauthnUsed Boolean  @default(true)
  reverifyRequired Boolean @default(false)
  reverifyStatus ReverifyStatus @default(NOT_REQUIRED)
  reverifyRequestedAt DateTime?
  reverifyDeadlineAt DateTime?
  reverifyMarkedAt DateTime?
  reverifyAttemptCount Int @default(0)
  reverifyRetryCount Int @default(0)
  reverifyPasskeyUsed Boolean @default(false)
  reverifyManualOverride Boolean @default(false)
  reverifyManualOverriddenAt DateTime?
  confidence   Int
  flagged      Boolean  @default(false)
  // New device and security fields
  deviceToken  String?  // Which device submitted this
  bleSignalStrength Int? // RSSI value (-100 to -20, higher is stronger)
  deviceConsistency Float? // 0-100 score
  gpsVelocity  Float?   // Movement speed in m/s
  anomalyScore Float?   // 0-100, higher = more suspicious
  markedAt     DateTime @default(now())

  session AttendanceSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student User              @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([sessionId, studentId])
  @@index([sessionId])
  @@index([studentId])
  @@index([flagged])
  @@index([reverifyStatus])
  @@index([anomalyScore])
  @@index([deviceToken])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  metadata  Json     @default("{}")
  ipAddress String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model TrustedIpRange {
  id             String @id @default(cuid())
  organizationId String
  cidr           String
  label          String

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model Subscription {
  id             String           @id @default(cuid())
  organizationId String           @unique
  plan           SubscriptionPlan @default(FREE)
  maxStudents    Int              @default(100)
  maxCourses     Int              @default(10)
  stripeCustomerId   String?
  stripeSubscriptionId String?
  currentPeriodEnd DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model LecturerInvite {
  id             String   @id @default(cuid())
  organizationId String
  invitedEmail   String
  tokenHash      String   @unique
  invitedByUserId String
  expiresAt      DateTime
  acceptedAt     DateTime?
  revokedAt      DateTime?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedBy    User         @relation("LecturerInvitesCreatedBy", fields: [invitedByUserId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([invitedEmail])
  @@index([expiresAt])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  email     String
  tokenHash String   @unique
  type      EmailVerificationTokenType @default(PERSONAL_EMAIL_VERIFY)
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@index([expiresAt])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  email     String
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@index([expiresAt])
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
  @@index([userId])
}

model UserNotification {
  id        String   @id @default(cuid())
  userId    String
  type      NotificationType @default(SYSTEM)
  title     String
  body      String
  metadata  Json     @default("{}")
  readAt    DateTime?
  sentAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([type])
}

// Device linking for multi-device attendance and BLE verification
model UserDevice {
  id               String   @id @default(cuid())
  userId           String
  deviceToken      String   @unique // Device identifier (Android/iOS)
  deviceName       String   // e.g., "iPhone 14 Pro"
  deviceType       String   // "iOS" | "Android" | "Web"
  osVersion        String?
  appVersion       String?
  bleSignature     String?  // BLE advertiser identifier (platform-specific)
  bleLastSeen      DateTime?
  fingerprint      String?  // Hardware fingerprint for spoofing detection
  lastUsedAt       DateTime @default(now())
  trustedAt        DateTime? // Manually verified by admin
  revokedAt        DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([deviceToken])
  @@index([revokedAt])
  @@index([bleSignature])
}

// Enhanced attendance records with device and velocity info
model AttendanceRecordExtended {
  id                String   @id @default(cuid())
  attendanceRecordId String  @unique // References AttendanceRecord.id
  deviceToken       String?  // Which device was used
  bleSignalStrength Int?     // RSSI value from source device (-100 to -20)
  deviceConsistency Float?   // Historical device match score (0-100)
  gpsVelocity       Float?   // Calculated movement speed (m/s)
  lastLocationLat   Float?   // Last known location for velocity
  lastLocationLng   Float?
  lastLocationTime  DateTime?
  anomalyScore      Float?   // 0-100, higher = more suspicious
  anomalyFlags      String[] // Array of detected anomalies
  locationJump      Boolean @default(false) // Teleportation detected
  velocityAnomaly   Boolean @default(false) // Movement too fast
  deviceMismatch    Boolean @default(false) // Different device than usual
  createdAt         DateTime @default(now())

  @@index([attendanceRecordId])
  @@index([anomalyScore])
}

// Anomaly detection and security monitoring
enum AnomalyType {
  LOCATION_JUMP      // Distance/time impossible
  VELOCITY_ANOMALY   // Moving too fast
  DEVICE_MISMATCH    // Different device than normal
  RAPID_SUBMISSIONS  // Too many attempts in short time
  GPS_SPOOFING       // Invalid movement pattern
  QR_REUSE           // Same QR used by multiple students
  IP_MISMATCH        // IP doesn't match student location
  TIMEZONE_ANOMALY   // Timestamp doesn't match timezone
  BEHAVIORAL_CHANGE  // Unusual attendance pattern
}

model AttendanceAnomaly {
  id          String     @id @default(cuid())
  studentId   String
  sessionId   String?
  anomalyType AnomalyType
  severity    Int        @default(50) // 0-100
  confidence  Float      @default(0.5) // 0.0-1.0
  details     Json       @default("{}")
  flaggedAt   DateTime   @default(now())
  reviewedAt  DateTime?
  reviewedBy  String?    // Admin user ID
  action      String?    // "none" | "flag" | "invalidate" | "investigate"
  actionReason String?
  createdAt   DateTime   @default(now())

  student    User     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([sessionId])
  @@index([anomalyType])
  @@index([severity])
  @@index([reviewedAt])
  @@index([flaggedAt])
}

// Session monitoring for real-time admin dashboard
model SessionMonitoring {
  id          String   @id @default(cuid())
  sessionId   String   @unique
  totalEnrolled    Int     @default(0)
  totalAttempted   Int     @default(0)
  totalVerified    Int     @default(0)
  flaggedCount     Int     @default(0)
  anomalyCount     Int     @default(0)
  lastUpdated      DateTime @default(now())
  estimatedCompletion DateTime? // Projected completion time
  
  createdAt DateTime @default(now())

  @@index([sessionId])
}

// BLE device signature storage for proximity verification
model BleDeviceSignature {
  id             String   @id @default(cuid())
  userDeviceId   String   @unique
  bleAddress     String   // BLE MAC or permanent address
  bleUuid        String?  // BLE UUID if using
  txPower        Int?     // Transmission power (calibration)
  lastVerified   DateTime @default(now())
  verificationCount Int   @default(0)
  createdAt      DateTime @default(now())

  userDevice UserDevice @relation(fields: [userDeviceId], references: [id], onDelete: Cascade)

  @@index([bleAddress])
  @@index([userDeviceId])
}
