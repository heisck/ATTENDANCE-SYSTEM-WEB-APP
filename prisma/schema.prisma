generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  LECTURER
  STUDENT
}

enum SessionStatus {
  ACTIVE
  CLOSED
}

enum AttendancePhase {
  INITIAL
  REVERIFY
  CLOSED
}

enum ReverifyStatus {
  NOT_REQUIRED
  PENDING
  RETRY_PENDING
  MISSED
  PASSED
  FAILED
  MANUAL_PRESENT
}

enum SubscriptionPlan {
  FREE
  BASIC
  PRO
  ENTERPRISE
}

enum EmailVerificationTokenType {
  PERSONAL_EMAIL_VERIFY
}

enum NotificationType {
  UPCOMING_CLASS
  ATTENDANCE_RISK
  SYSTEM
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  domain    String?
  logoUrl   String?
  settings  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users        User[]
  courses      Course[]
  subscription Subscription?
  ipRanges     TrustedIpRange[]
  lecturerInvites LecturerInvite[]

  @@index([slug])
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  personalEmail  String?  @unique
  name           String
  passwordHash   String
  role           Role     @default(STUDENT)
  studentId      String?  @unique
  indexNumber    String?  @unique
  organizationId String?
  emailVerified  DateTime?
  personalEmailVerifiedAt DateTime?
  lastProfileCompletionPromptAt DateTime?
  image          String?
  passkeysLockedUntilAdminReset Boolean @default(false)
  firstPasskeyCreatedAt DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization?        @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  credentials  WebAuthnCredential[]
  attendances  AttendanceRecord[]
  sessions     AttendanceSession[]  @relation("LecturerSessions")
  courses      Course[]             @relation("LecturerCourses")
  enrollments  Enrollment[]
  auditLogs    AuditLog[]
  lecturerInvitesCreated LecturerInvite[] @relation("LecturerInvitesCreatedBy")
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens PasswordResetToken[]
  pushSubscriptions PushSubscription[]
  notifications UserNotification[]

  @@index([email])
  @@index([personalEmail])
  @@index([organizationId])
  @@index([role])
  @@index([passkeysLockedUntilAdminReset])
}

model WebAuthnChallenge {
  id        String   @id @default(cuid())
  userId    String
  challenge String
  expiresAt DateTime

  @@index([userId])
  @@index([expiresAt])
}

model WebAuthnCredential {
  id               String   @id @default(cuid())
  userId           String
  credentialId     String   @unique
  publicKey        Bytes
  counter          BigInt   @default(0)
  transports       String[]
  deviceType       String
  backedUp         Boolean  @default(false)
  userAgent        String?
  registeredAt     DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([credentialId])
}

model Course {
  id             String   @id @default(cuid())
  code           String
  name           String
  description    String?
  organizationId String
  lecturerId     String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  lecturer     User                @relation("LecturerCourses", fields: [lecturerId], references: [id])
  enrollments  Enrollment[]
  sessions     AttendanceSession[]

  @@unique([code, organizationId])
  @@index([organizationId])
  @@index([lecturerId])
}

model Enrollment {
  id        String   @id @default(cuid())
  courseId   String
  studentId  String
  enrolledAt DateTime @default(now())

  course  Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student User   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([courseId, studentId])
}

model AttendanceSession {
  id           String        @id @default(cuid())
  courseId      String
  lecturerId   String
  status       SessionStatus @default(ACTIVE)
  phase        AttendancePhase @default(INITIAL)
  initialEndsAt DateTime?
  reverifyEndsAt DateTime?
  qrRotationMs Int           @default(5000)
  qrGraceMs    Int           @default(1000)
  reverifySelectionRate Float @default(0.3)
  reverifySelectionDone Boolean @default(false)
  reverifySelectedCount Int  @default(0)
  gpsLat       Float
  gpsLng       Float
  radiusMeters Int           @default(500)
  qrSecret     String
  startedAt    DateTime      @default(now())
  closedAt     DateTime?

  course   Course             @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lecturer User               @relation("LecturerSessions", fields: [lecturerId], references: [id])
  records  AttendanceRecord[]

  @@index([courseId])
  @@index([lecturerId])
  @@index([status])
  @@index([phase])
}

model AttendanceRecord {
  id           String   @id @default(cuid())
  sessionId    String
  studentId    String
  gpsLat       Float
  gpsLng       Float
  gpsDistance   Float
  ipAddress    String
  ipTrusted    Boolean  @default(false)
  qrToken      String
  webauthnUsed Boolean  @default(true)
  reverifyRequired Boolean @default(false)
  reverifyStatus ReverifyStatus @default(NOT_REQUIRED)
  reverifyRequestedAt DateTime?
  reverifyDeadlineAt DateTime?
  reverifyMarkedAt DateTime?
  reverifyAttemptCount Int @default(0)
  reverifyRetryCount Int @default(0)
  reverifyPasskeyUsed Boolean @default(false)
  reverifyManualOverride Boolean @default(false)
  reverifyManualOverriddenAt DateTime?
  confidence   Int
  flagged      Boolean  @default(false)
  markedAt     DateTime @default(now())

  session AttendanceSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student User              @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([sessionId, studentId])
  @@index([sessionId])
  @@index([studentId])
  @@index([flagged])
  @@index([reverifyStatus])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  metadata  Json     @default("{}")
  ipAddress String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model TrustedIpRange {
  id             String @id @default(cuid())
  organizationId String
  cidr           String
  label          String

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model Subscription {
  id             String           @id @default(cuid())
  organizationId String           @unique
  plan           SubscriptionPlan @default(FREE)
  maxStudents    Int              @default(100)
  maxCourses     Int              @default(10)
  stripeCustomerId   String?
  stripeSubscriptionId String?
  currentPeriodEnd DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model LecturerInvite {
  id             String   @id @default(cuid())
  organizationId String
  invitedEmail   String
  tokenHash      String   @unique
  invitedByUserId String
  expiresAt      DateTime
  acceptedAt     DateTime?
  revokedAt      DateTime?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedBy    User         @relation("LecturerInvitesCreatedBy", fields: [invitedByUserId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([invitedEmail])
  @@index([expiresAt])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  email     String
  tokenHash String   @unique
  type      EmailVerificationTokenType @default(PERSONAL_EMAIL_VERIFY)
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@index([expiresAt])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  email     String
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@index([expiresAt])
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
  @@index([userId])
}

model UserNotification {
  id        String   @id @default(cuid())
  userId    String
  type      NotificationType @default(SYSTEM)
  title     String
  body      String
  metadata  Json     @default("{}")
  readAt    DateTime?
  sentAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([type])
}
